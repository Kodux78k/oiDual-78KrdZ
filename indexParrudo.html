<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Dual.Vault v9 - 78KrdZ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#050505">

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
    .then(() => console.log("SW ok"))
    .catch(e => console.log("SW erro", e));
}
</script>

<link rel="apple-touch-icon" href="./icon-192.png">

<!-- DOMPurify (recomendado para sanitiza√ß√£o de HTML remoto) -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
    --bg: #050505;
    --glass: rgba(30, 30, 30, 0.4);
    --border: rgba(255, 255, 255, 0.08);
    --neon-p: #23ac51; /* verde Cyber */
    --neon-o: #f97316; /* Laranja Hub */
    --neon-b: #3b82f6; /* Azul Warframe */
}

body {
    background: var(--bg);
    font-family: 'Plus Jakarta Sans', sans-serif;
    display: flex; flex-direction: column; align-items: center;
    padding: 20px 10px; min-height: 100vh; color: #e2e8f0;
    overflow-x: hidden;
}

/* --- CARD SYSTEM --- */
.master-card {
    width: 100%; max-width: 460px;
    background: var(--glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-radius: 24px; border: 1px solid var(--border);
    margin-bottom: 16px; position: relative; overflow: hidden;
    transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
}

/* Aura de Sele√ß√£o */
.master-card:focus-within { border-color: var(--neon-b); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }

.inner { padding: 14px; }

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; min-height: 44px; }
.title-group { flex-grow: 1; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; }
.card-title { font-weight: 800; font-size: 14px; color: #f8fafc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-meta { font-size: 10px; color: #94a3b8; font-family: 'JetBrains Mono', monospace; display: flex; gap: 8px; align-items: center; margin-top: 2px;}
.tag-badge { background: rgba(255,255,255,0.1); padding: 1px 6px; border-radius: 4px; color: var(--neon-p); }

/* DOCK DE A√á√ÉO */
.dock { display: flex; gap: 6px; align-items: center; padding-left: 8px;}
.ico {
    width: 34px; height: 34px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
    color: #cbd5e1; cursor: pointer; transition: all 0.2s;
    flex-shrink: 0;
}
.ico:hover { background: rgba(255,255,255,0.1); color: white; transform: scale(1.05); }
.ico:active { transform: scale(0.95); }

/* CORES DE A√á√ÉO */
.ico.flash { color: var(--neon-o); border-color: rgba(249, 115, 22, 0.3); }
.ico.tts { color: var(--neon-b); }
.ico.share { color: #10b981; }
.ico.del:hover { background: #ef4444; color: white; border-color: #ef4444; }

/* CONTE√öDO EXPANS√çVEL */
.content-box {
    max-height: 0; overflow: hidden; opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.expanded .content-box { max-height: 800px; opacity: 1; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }

/* INPUTS & WARFRAME */
.code-area {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px; color: #e2e8f0;
    font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.5;
    outline: none; resize: vertical; min-height: 100px;
}
/* Atualizado conforme patch: mais altura e fundo branco para compatibilidade com scripts */
.warframe-view {
    width: 100%; 
    height: 300px; /* Mais altura para ver melhor */
    border: none; 
    background: white; /* Garante contraste */
    border-radius: 12px; 
    margin-top: 8px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
}

/* CAMADA EXTERNA (Inject Outside) */
#ext-layer { width: 100%; max-width: 460px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
.ext-card-wrap { animation: slideIn 0.3s ease; }

@keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* GROUP FILTER */
.filter-bar {
    width: 100%; max-width: 460px; display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;
}
.filter-pill {
    background: var(--glass); border: 1px solid var(--border); color: #94a3b8;
    padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: 600;
    cursor: pointer; white-space: nowrap; transition: 0.2s;
}
.filter-pill.active { background: var(--neon-p); color: white; border-color: var(--neon-p); }

/* small helpers for fusion-card list */
.fusion-list { display:flex; flex-direction:column; gap:10px; width:100%; max-width:460px; margin-top:8px; }
.fusion-meta { font-size:12px; color:#94a3b8; margin-bottom:6px; }
.selected-fusion { box-shadow:0 12px 36px rgba(0,0,0,0.6); border:1px solid rgba(0,240,255,0.06); }

/* Templates panel */
.templates-panel { width:100%; max-width:460px; margin-top:12px; display:flex; gap:12px; align-items:flex-start; }
.templates-list { display:flex; flex-direction:column; gap:8px; width: 60%; }
.templates-preview { width:40%; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-family:monospace; font-size:13px; color:#e2e8f0; white-space:pre-wrap; min-height:80px; }
.template-btn { padding:8px 10px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); cursor:pointer; text-align:left; color:#e2e8f0; }
.template-btn:hover { background: rgba(255,255,255,0.02); }
</style>
</head>
<body>

<div id="ext-layer"></div>

<div class="filter-bar" id="filterBar">
    <div class="filter-pill active" onclick="filterVault('ALL')">ALL</div>
    <div class="filter-pill" onclick="filterVault('CODE')">CODE</div>
    <div class="filter-pill" onclick="filterVault('DOCS')">DOCS</div>
</div>

<div class="master-card" id="main">
    <div class="inner">
        <div class="header">
            <div class="title-group" onclick="toggle('main')">
                <span class="card-title" style="letter-spacing: 1px; color: var(--neon-o);">‚ö° INFINITY INJECTOR</span>
                <span class="card-meta">WARFRAME_READY ‚Ä¢ v9.0</span>
            </div>
            <div class="dock">
                <button class="ico flash" onclick="magicPaste()" title="Clipboard Turbo Save">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                </button>
                <button class="ico" onclick="toggle('main')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>
        </div>
        
        <div class="content-box">
            <div style="position: relative;">
                <textarea id="mainInput" class="code-area" rows="6" placeholder="Cole HTML, c√≥digo ou URL aqui ‚Äî depois clique em ‚ï∞‚Ü≥KrdZ‚Ü¥ para criar um Fusion Card com o m√≥dulo injetado"></textarea>
                <button id="btnPasteToInput" onclick="pasteToInput()" style="position: absolute; bottom: 8px; right: 92px; background: var(--neon-p); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">
                  ‚çØ
                </button>
                <button id="btnInjectExternal" class="ico" title="Criar Fusion Card / injetar m√≥dulo" style="position: absolute; bottom: 6px; right: 8px; width:auto;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);">
                  ‚ï∞‚Ü≥KrdZ‚Ü¥
                </button>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <input id="mainGroup" placeholder="(StkZ)" style="background:transparent; border:1px solid var(--border); color:white; padding:8px; border-radius:8px; width: 20%; font-size: 11px;">
                
                <button class="ico" style="flex:1; border-radius: 8px; width:auto; font-size: 11px; font-weight:700; gap:6px;" onclick="saveManual()">
                   ‚ò•ÿ≥Œ£9‚Ä¢
                </button>

                <input type="file" id="importFile" accept=".json,.html,.md,.patch,.rds, .css, .js, .txt" style="display:none" onchange="importBackup(event)">
                <button class="ico" style="flex:1; border-radius: 8px; font-size: 11px; font-weight:700;" onclick="document.getElementById('importFile').click()">
                   Ôø¨‚üêÔø¨‚ßâÔø¨
                </button>
            </div>
        </div>
    </div>
</div>

<div id="vault" style="width: 100%; max-width: 460px;"></div>

<!-- area onde listamos fusion-cards criados -->
<div class="fusion-list" id="fusionList" aria-live="polite"></div>

<!-- Templates locais (exemplos) -->
<div class="templates-panel">
  <div class="templates-list">
    <strong style="margin-bottom:6px">Templates locais</strong>
    <button class="template-btn" data-tpl="tpl-cta">Template ‚Äî CTA (bot√µes)</button>
    <button class="template-btn" data-tpl="tpl-note">Template ‚Äî Nota / Texto</button>
    <button class="template-btn" data-tpl="tpl-miniapp">Template ‚Äî Mini App (input)</button>
    <div style="margin-top:8px; display:flex; gap:8px">
      <button id="btnInjectSelectedTemplate" class="template-btn" style="flex:1">Injetar template selecionado (ou criar novo)</button>
      <button id="btnPreviewTemplate" class="template-btn" style="width:120px">Pr√©-visualizar</button>
    </div>
  </div>

  <div class="templates-preview" id="tplPreviewLocal">// selecione um template para ver o preview</div>
</div>

<!-- Template markup (declarativo) -->
<template id="tpl-cta">
  <div style="padding:8px; display:flex; gap:8px; align-items:center; justify-content:space-between;">
    <div style="flex:1">
      <div style="font-weight:700">A√ß√£o R√°pida</div>
      <div style="font-size:13px; color:#9ca3af">Executa tarefas comuns</div>
    </div>
    <div style="display:flex; gap:6px;">
      <button onclick="alert('Executando A√ß√£o 1')">A√ß√£o 1</button>
      <button onclick="alert('Executando A√ß√£o 2')">A√ß√£o 2</button>
    </div>
  </div>
</template>

<template id="tpl-note">
  <div style="padding:8px;">
    <div style="font-weight:700; margin-bottom:6px">Observa√ß√£o</div>
    <p style="margin:0; color:#cbd5e1">Este √© um trecho informativo que pode ser injetado como m√≥dulo. Use para instru√ß√µes, docs curtas, ou notas.</p>
  </div>
</template>

<template id="tpl-miniapp">
  <div style="padding:8px; display:flex; gap:8px; flex-direction:column;">
    <div style="font-weight:700">Mini App ‚Äî Quick Form</div>
    <input placeholder="Digite algo..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff" id="mini-input"/>
    <div style="display:flex; gap:8px;">
      <button onclick="(function(e){ const root = e.target.closest('[slot]') || e.target.closest('.injected-module'); const val = root?.querySelector('#mini-input')?.value || ''; alert('Enviado: '+val); })(event)">Enviar</button>
      <button onclick="(function(e){ const root = e.target.closest('[slot]') || e.target.closest('.injected-module'); root && (root.querySelector('#mini-input').value=''); })(event)">Limpar</button>
    </div>
  </div>
</template>

<script type="module">
import './fusion-card-element.js';

let items = JSON.parse(localStorage.getItem('vault_v9') || '[]');
let currentFilter = 'ALL';
let editingId = null;
let selectedFusionCard = null; // refer√™ncia ao fusion-card DOM
let lastSelectedTemplateId = null; // id do template selecionado na interface

// helper sanitize: usa DOMPurify se dispon√≠vel, sen√£o fallback
function sanitizeHTML(input){
  if(!input) return '';
  if(window.DOMPurify && typeof DOMPurify.sanitize === 'function'){
    return DOMPurify.sanitize(input, {SAFE_FOR_TEMPLATES: true});
  }
  try {
    const doc = new DOMParser().parseFromString(input, 'text/html');
    doc.querySelectorAll('script,iframe,style,link').forEach(n => n.remove());
    const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null, false);
    while(walker.nextNode()){
      const el = walker.currentNode;
      [...el.attributes].forEach(attr=>{
        if(/^on/i.test(attr.name) || attr.name.toLowerCase() === 'srcdoc') el.removeAttribute(attr.name);
      });
    }
    return doc.body.innerHTML;
  } catch(e){
    console.warn('sanitize fallback failed', e);
    return '';
  }
}

// ---------------- existing app render & functions (kept) ---------------- //
function render() {
    const v = document.getElementById('vault');
    const filtered = currentFilter === 'ALL' ? items : items.filter(i => (i.group || '').toUpperCase() === currentFilter);
    
    v.innerHTML = filtered.map(i => {
        const isEditing = editingId === i.id;
        
        if (isEditing) {
            return `
            <div class="master-card expanded" id="card-${i.id}">
                <div class="inner">
                    <div class="header">
                        <input id="edit-title-${i.id}" value="${escapeHtml(i.title)}" class="code-area" style="height:34px; min-height:auto; padding:5px 10px; width: 60%;">
                        <input id="edit-group-${i.id}" value="${escapeHtml(i.group||'')}" class="code-area" style="height:34px; min-height:auto; padding:5px 10px; width: 20%; margin-left:5px;">
                        <div class="dock" style="margin-left: auto;">
                            <button class="ico flash" onclick="saveEdit(${i.id})">‚úì</button>
                        </div>
                    </div>
                    <div class="content-box" style="opacity:1; max-height:none;">
                        <textarea id="edit-content-${i.id}" class="code-area" rows="8">${escapeHtml(i.content)}</textarea>
                    </div>
                </div>
            </div>`;
        }
        
        return `
        <div class="master-card" id="card-${i.id}">
            <div class="inner">
                <div class="header">
                    <div class="title-group" onclick="toggle('card-${i.id}')">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <span class="card-title">${escapeHtml(i.title)}</span>
                            <span class="card-meta">${i.date.split(' ')[0]}</span>
                        </div>
                        <span class="card-meta">
                            ${i.group ? `<span class="tag-badge">${escapeHtml(i.group)}</span>` : ''} 
                            ID:${i.id.toString().slice(-4)}
                        </span>
                    </div>
                    
                    <div class="dock">
                        <button class="ico tts" onclick="event.stopPropagation(); speakCard(${i.id})">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                        </button>

                        <button class="ico share" onclick="event.stopPropagation(); shareCard(${i.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        </button>

                        <button class="ico" onclick="event.stopPropagation(); toggleRender(${i.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                        </button>

                        <button class="ico" onclick="event.stopPropagation(); startEdit(${i.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>

                         <button class="ico del" onclick="event.stopPropagation(); deleteCard(${i.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                
                <div class="content-box" id="box-${i.id}">
                    <textarea readonly class="code-area" id="txt-${i.id}" style="border:none; padding:0; background:transparent;">${escapeHtml(i.content)}</textarea>
                    <div id="frame-container-${i.id}" style="display:none;"></div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// escape helper
function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function toggle(id) {
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle('expanded');
}

function saveManual() {
    const text = document.getElementById('mainInput').value;
    const group = document.getElementById('mainGroup').value;
    if(text) { createCard(text, group); document.getElementById('mainInput').value = ''; toggle('main'); }
}

async function magicPaste() {
    try {
        const text = await navigator.clipboard.readText();
        if(!text) return alert("Clipboard Vazio");
        createCard(text, "CLIPBOARD");
        speak("Card Criado");
    } catch(e) { alert("Permiss√£o de colar negada"); }
}

async function pasteToInput() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('mainInput').value += text;
    } catch(e) { alert("Permiss√£o negada"); }
}

function createCard(content, group = "") {
    const lines = content.trim().split('\n');
    const title = lines[0].substring(0, 35).replace(/[#<*]/g,'').trim() || "Sem T√≠tulo";
    const item = { 
        id: Date.now(), 
        title, 
        content, 
        group: group.toUpperCase(), 
        date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR').slice(0,5) 
    };
    items.unshift(item);
    save();
}

async function shareCard(id) {
    const item = items.find(i => i.id === id);
    if (navigator.share) {
        try {
            await navigator.share({
                title: item.title,
                text: item.content
            });
        } catch (err) { console.log('Share cancelado'); }
    } else {
        navigator.clipboard.writeText(item.content);
        alert("Copiado para Clipboard (Share n√£o suportado)");
    }
}

function speakCard(id) {
    const item = items.find(i => i.id === id);
    speak(item.content);
}

function speak(txt) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = "pt-BR"; u.rate = 1.2;
    window.speechSynthesis.speak(u);
}

function toggleRender(id) {
    const txt = document.getElementById(`txt-${id}`);
    const frameBox = document.getElementById(`frame-container-${id}`);
    const item = items.find(i => i.id === id);

    if (frameBox.style.display === 'none' || frameBox.innerHTML === '') {
        txt.style.display = 'none';
        frameBox.style.display = 'block';
        frameBox.innerHTML = '';
        const toolbar = document.createElement('div');
        toolbar.style.cssText = "display:flex; justify-content:flex-end; gap:8px; margin-bottom:6px;";
        const btnExpand = document.createElement('button');
        btnExpand.innerHTML = '‚õ∂ Expandir';
        btnExpand.className = 'tag-badge';
        btnExpand.style.cursor = 'pointer';
        btnExpand.onclick = function(e) {
            e.stopPropagation();
            const fs = document.createElement('div');
            fs.style.cssText = "position:fixed; inset:0; z-index:9999; background:#000; padding:20px; display:flex; flex-direction:column;";
            const closeFs = document.createElement('button');
            closeFs.innerText = "‚ùå Fechar Modo Cinema";
            closeFs.style.cssText = "align-self:flex-end; padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:6px; margin-bottom:10px; cursor:pointer; font-weight:bold;";
            closeFs.onclick = () => fs.remove();
            const bigFrame = document.createElement('iframe');
            bigFrame.style.cssText = "width:100%; height:100%; border:none; background:#fff; border-radius:8px;";
            bigFrame.setAttribute('sandbox', 'allow-scripts allow-modals allow-forms allow-same-origin');
            fs.appendChild(closeFs);
            fs.appendChild(bigFrame);
            document.body.appendChild(fs);
            const doc = bigFrame.contentWindow.document;
            doc.open();
            doc.write(item.content);
            doc.close();
        };

        toolbar.appendChild(btnExpand);
        const btnClose = document.createElement('button');
        btnClose.innerText = '‚úñ Fechar';
        btnClose.className = 'tag-badge';
        btnClose.style.cursor = 'pointer';
        btnClose.onclick = function(e) {
            e.stopPropagation();
            txt.style.display = 'block';
            frameBox.style.display = 'none';
            frameBox.innerHTML = '';
        };
        toolbar.appendChild(btnClose);
        frameBox.appendChild(toolbar);
        const iframe = document.createElement('iframe');
        iframe.className = 'warframe-view';
        iframe.style.height = "300px";
        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
        frameBox.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(item.content);
        doc.close();

    } else {
        txt.style.display = 'block';
        frameBox.style.display = 'none';
        frameBox.innerHTML = '';
    }
}

// ---------------- NEW: Fusion Card injector functions ---------------- //

function createFusionCard({ title = 'Fusion Card', username = '', moduleHTML = null } = {}) {
  const fusionList = document.getElementById('fusionList');
  const vault = document.getElementById('vault');

  const wrapper = document.createElement('div');
  wrapper.className = 'ext-card-wrap';
  const fc = document.createElement('fusion-card');
  if(username && typeof fc.setUserName === 'function') fc.setUserName(username);
  const meta = document.createElement('div');
  meta.className = 'fusion-meta';
  meta.innerHTML = `<span style="font-weight:700">${escapeHtml(title)}</span> &nbsp; <small style="color:#94a3b8">¬∑ fusion</small>`;

  wrapper.addEventListener('click', (e)=>{
    e.stopPropagation();
    document.querySelectorAll('.ext-card-wrap').forEach(n => n.classList.remove('selected-fusion'));
    wrapper.classList.add('selected-fusion');
    selectedFusionCard = fc;
  });

  wrapper.appendChild(meta);
  wrapper.appendChild(fc);
  fusionList.prepend(wrapper);

  const d = document.createElement('div');
  d.innerHTML = `
    <div class="master-card ext-card-wrap">
      <div class="inner">
        <div class="header">
             <span class="card-title" style="color:var(--neon-b)">üöÄ ${escapeHtml(title)}</span>
             <div class="dock"><button class="ico del" onclick="this.closest('.ext-card-wrap').remove()">√ó</button></div>
        </div>
        <div style="margin-top:10px; color:#ccc; font-size:13px;">
            ${escapeHtml(title)} 
        </div>
      </div>
    </div>
  `;
  document.getElementById('ext-layer').appendChild(d);

  // if moduleHTML provided, inject sanitized version
  if(moduleHTML){
    try {
      const safe = typeof moduleHTML === 'string' ? sanitizeHTML(moduleHTML) : '';
      if(fc.setModuleHTML) fc.setModuleHTML(safe || `<pre style="white-space:pre-wrap;color:#fff;background:transparent;border:none">${escapeHtml(moduleHTML)}</pre>`);
    } catch(e){
      console.warn('erro ao injetar moduleHTML', e);
    }
  }

  // auto-select created
  wrapper.classList.add('selected-fusion');
  selectedFusionCard = fc;
  return fc;
}

// main injectExternal replacement (kept)
async function injectExternal() {
  const raw = document.getElementById('mainInput').value.trim();
  const group = document.getElementById('mainGroup').value || '';
  if(!raw) return alert('Cole HTML, URL ou texto no campo principal.');

  // if raw looks like a URL, try fetch
  const isUrl = /^(https?:\/\/|\/)/i.test(raw);
  if(isUrl){
    try {
      const resp = await fetch(raw, {cache:'no-store'});
      if(!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
      let text = await resp.text();
      text = sanitizeHTML(text);
      const target = selectedFusionCard || createFusionCard({ title: extractTitleFromContent(text) || 'Remote Module', username: '', moduleHTML: text });
      if(target && target.setModuleHTML) {
        target.setModuleHTML(text);
        toast('M√≥dulo remoto injetado no Fusion Card');
      }
      document.getElementById('mainInput').value = '';
      return;
    } catch(err){
      console.error('fetch error', err);
      return alert('Erro ao buscar URL. Verifique a origem ou use HTML direto.');
    }
  }

  // not a URL => treat as HTML snippet or plain text
  const looksLikeHtml = /^\s*</.test(raw);
  const safe = looksLikeHtml ? sanitizeHTML(raw) : `<pre style="white-space:pre-wrap; color:#dbeafe; font-family:monospace; background:transparent; border:none;">${escapeHtml(raw)}</pre>`;

  const targetCard = selectedFusionCard || createFusionCard({ title: extractTitleFromContent(raw) || 'Fusion Snippet', username: '', moduleHTML: safe });
  if(targetCard && targetCard.setModuleHTML){
    targetCard.setModuleHTML(safe);
    toast('M√≥dulo injetado no Fusion Card');
  } else {
    toast('Fusion Card criado e m√≥dulo injetado');
  }
  document.getElementById('mainInput').value = '';
}

// small util: choose a sensible title from content
function extractTitleFromContent(text){
  if(!text) return '';
  const m = text.trim().split('\n').find(l => l.trim().length > 0);
  if(!m) return '';
  return m.replace(/<[^>]*>/g,'').slice(0, 28);
}

// tiny toast
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.right='12px'; t.style.bottom='12px';
  t.style.background='rgba(0,0,0,0.8)'; t.style.color='#fff'; t.style.padding='8px 12px'; t.style.borderRadius='8px';
  t.style.fontFamily='monospace'; t.style.zIndex=9999; t.style.opacity='0'; t.style.transform='translateY(8px)';
  document.body.appendChild(t);
  requestAnimationFrame(()=> { t.style.transition='all .26s'; t.style.opacity='1'; t.style.transform='translateY(0)'; });
  setTimeout(()=> { t.style.opacity='0'; t.style.transform='translateY(8px)'; setTimeout(()=>t.remove(),280); }, 2000);
}

// expose API to window
window.FusionInjector = {
  createFusionCard,
  injectToSelected: (html, sanitize=true) => {
    const safe = sanitize ? sanitizeHTML(html) : html;
    const target = selectedFusionCard || createFusionCard({ title: extractTitleFromContent(html) || 'Programmatic', moduleHTML: safe });
    if(target.setModuleHTML) target.setModuleHTML(safe);
    return target;
  },
  sanitizeHTML,
  selectLastCreated: () => { const last = document.querySelector('.ext-card-wrap fusion-card'); if(last){ last.closest('.ext-card-wrap').classList.add('selected-fusion'); selectedFusionCard = last; } return selectedFusionCard; }
};

// ---------------- templates UI logic ---------------- //
const tplBtns = Array.from(document.querySelectorAll('.template-btn'));
const tplPreview = document.getElementById('tplPreviewLocal');
const btnInjectSelectedTemplate = document.getElementById('btnInjectSelectedTemplate');
const btnPreviewTemplate = document.getElementById('btnPreviewTemplate');

tplBtns.forEach(b => {
  b.addEventListener('click', (e) => {
    tplBtns.forEach(x => x.style.outline = 'none');
    e.currentTarget.style.outline = '2px solid rgba(0,242,255,0.12)';
    lastSelectedTemplateId = e.currentTarget.getAttribute('data-tpl');
    // show preview
    const tpl = document.getElementById(lastSelectedTemplateId);
    tplPreview.innerText = tpl ? tpl.innerHTML.trim() : '// empty';
  });
});

btnPreviewTemplate.addEventListener('click', ()=>{
  if(!lastSelectedTemplateId) { alert('Selecione um template primeiro'); return; }
  const tpl = document.getElementById(lastSelectedTemplateId);
  tplPreview.innerText = tpl ? tpl.innerHTML.trim() : '// empty';
});

btnInjectSelectedTemplate.addEventListener('click', ()=>{
  if(!lastSelectedTemplateId) { alert('Selecione um template para injetar'); return; }
  injectTemplateById(lastSelectedTemplateId);
});

function injectTemplateById(tplId){
  const tpl = document.getElementById(tplId);
  if(!tpl) return alert('Template n√£o encontrado');
  const html = tpl.innerHTML;
  const safe = sanitizeHTML(html);
  // if there's a selected fusion-card, inject; otherwise create new and inject
  let target = selectedFusionCard;
  if(!target){
    target = createFusionCard({ title: extractTitleFromContent(html) || 'Template', moduleHTML: safe });
  }
  if(target && target.setModuleHTML){
    target.setModuleHTML(safe);
    // visually select wrapper of target
    const wrap = target.closest('.ext-card-wrap');
    document.querySelectorAll('.ext-card-wrap').forEach(n => n.classList.remove('selected-fusion'));
    if(wrap) wrap.classList.add('selected-fusion');
    selectedFusionCard = target;
    toast('Template injetado no Fusion Card');
  } else {
    toast('Falha ao injetar template');
  }
}

// ---------------- existing CRUD + helpers ---------------- //
function importBackup(ev) {
    const file = ev.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);

            if (!Array.isArray(data)) {
                alert("Arquivo inv√°lido: n√£o √© uma lista de cards.");
                return;
            }

            let count = 0;

            data.forEach(card => {
                if (card.content) {
                    card.id = Date.now() + Math.floor(Math.random() * 9999);
                    items.unshift(card);
                    count++;
                }
            });

            save();
            alert(count + " cards importados com sucesso!");
        } catch (err) {
            alert("Erro ao ler arquivo JSON.");
        }
    };

    reader.readAsText(file);
}

function startEdit(id) { editingId = id; render(); document.getElementById(`card-${id}`).classList.add('expanded'); }
function cancelEdit() { editingId = null; render(); }

function saveEdit(id) {
    const item = items.find(i => i.id === id);
    item.title = document.getElementById(`edit-title-${id}`).value;
    item.group = document.getElementById(`edit-group-${id}`).value.toUpperCase();
    item.content = document.getElementById(`edit-content-${id}`).value;
    item.date = new Date().toLocaleDateString() + " (Edit)";
    editingId = null;
    save();
}

function deleteCard(id) {
    if(confirm('Deletar Card?')) {
        items = items.filter(i => i.id !== id);
        save();
    }
}

function filterVault(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
    try { event.target.classList.add('active'); } catch(e){}
    render();
}

function save() {
    localStorage.setItem('vault_v9', JSON.stringify(items));
    render();
}

// initial render
render();

// wire main inject button
document.getElementById('btnInjectExternal').addEventListener('click', (e)=>{ e.preventDefault(); injectExternal(); });

</script>
</body>
</html>
